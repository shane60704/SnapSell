<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapSell 個人檔案</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.0/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f39c12;
            --tertiary-color: #2ecc71;
            --quaternary-color: #e74c3c;
            --background-color: #f5f8fa;
            --card-background: #ffffff;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .snap-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .snap-dashboard-chart-container {
            background-color: var(--card-background);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 40px;
            font-weight: 700;
        }
        h2 {
            color: var(--text-color);
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
        }
        .snap-dashboard-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }
        .snap-dashboard-chart-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .snap-dashboard-btn {
            background-color: var(--primary-color);
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .snap-dashboard-btn:hover {
            background-color: #3a7bc8;
            transform: translateY(-2px);
        }
        .snap-dashboard-btn.active {
            background-color: #2c3e50;
        }
        .snap-dashboard-total-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .snap-dashboard-stat-item {
            text-align: center;
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin: 10px;
            flex: 1 1 300px;
        }

        .snap-dashboard-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .snap-dashboard-stat-label {
            font-size: 1em;
            color: var(--text-color);
            margin-top: 5px;
        }

        .snap-dashboard-container {
            width: 60%;
        }
    </style>
</head>
<body>

<div class="snap-dashboard-container">
    <div class="snap-dashboard-controls">
        <button id="yearBtn" class="snap-dashboard-btn" onclick="changeTimeScale('year')">年</button>
        <button id="monthBtn" class="snap-dashboard-btn" onclick="changeTimeScale('month')">月</button>
        <button id="weekBtn" class="snap-dashboard-btn" onclick="changeTimeScale('week')">週</button>
        <button id="dayBtn" class="snap-dashboard-btn" onclick="changeTimeScale('day')">日</button>
    </div>

    <div class="snap-dashboard-total-stats">
        <div class="snap-dashboard-stat-item">
            <div class="snap-dashboard-stat-value" id="totalViewers">0</div>
            <div class="snap-dashboard-stat-label">總觀看人數</div>
        </div>
        <div class="snap-dashboard-stat-item">
            <div class="snap-dashboard-stat-value" id="totalSales">0</div>
            <div class="snap-dashboard-stat-label">總銷售數量</div>
        </div>
        <div class="snap-dashboard-stat-item">
            <div class="snap-dashboard-stat-value" id="totalFigures">0</div>
            <div class="snap-dashboard-stat-label">總銷售額</div>
        </div>
        <div class="snap-dashboard-stat-item">
            <div class="snap-dashboard-stat-value" id="totalCommission">0</div>
            <div class="snap-dashboard-stat-label">總佣金</div>
        </div>
    </div>

    <div class="snap-dashboard">
        <div class="snap-dashboard-chart-container">
            <h2>觀看人數</h2>
            <div id="viewersChart"></div>
        </div>
        <div class="snap-dashboard-chart-container">
            <h2>銷售數量</h2>
            <div id="salesChart"></div>
        </div>
        <div class="snap-dashboard-chart-container">
            <h2>銷售總額</h2>
            <div id="figuresChart"></div>
        </div>
        <div class="snap-dashboard-chart-container">
            <h2>佣金</h2>
            <div id="commissionChart"></div>
        </div>
    </div>
</div>

<script>
    // 從 localStorage 獲取使用者 ID
    const userId = localStorage.getItem("userId");
    // 設定預設時間尺度為 '日'
    let currentTimeScale = 'day';
    // 用於存儲圖表實例的物件
    let charts = {};

    // API 基礎 URL
    const apiBaseUrl = '/api/1.0/livestream';

    // 定義不同數據類型和時間尺度的 API 端點
    const apiEndpoints = {
        viewers: {
            year: `${apiBaseUrl}/yearly-viewers/${userId}`,
            month: `${apiBaseUrl}/monthly-viewers/${userId}`,
            week: `${apiBaseUrl}/weekly-viewers/${userId}`,
            day: `${apiBaseUrl}/daily-viewers/${userId}`
        },
        sales: {
            year: `${apiBaseUrl}/yearly-sales/${userId}`,
            month: `${apiBaseUrl}/monthly-sales/${userId}`,
            week: `${apiBaseUrl}/weekly-sales/${userId}`,
            day: `${apiBaseUrl}/daily-sales/${userId}`
        },
        figures: {
            year: `${apiBaseUrl}/yearly-figures/${userId}`,
            month: `${apiBaseUrl}/monthly-figures/${userId}`,
            week: `${apiBaseUrl}/weekly-figures/${userId}`,
            day: `${apiBaseUrl}/daily-figures/${userId}`
        },
        commissions: {
            year: `${apiBaseUrl}/yearly-commissions/${userId}`,
            month: `${apiBaseUrl}/monthly-commissions/${userId}`,
            week: `${apiBaseUrl}/weekly-commissions/${userId}`,
            day: `${apiBaseUrl}/daily-commissions/${userId}`
        }
    };

    // 從 API 獲取數據的非同步函數
    async function fetchData(endpoint) {
        try {
            const response = await axios.get(endpoint);
            return response.data.data;
        } catch (error) {
            console.error('獲取數據時發生錯誤:', error);
            return [];
        }
    }

    // 處理原始數據，生成圖表所需的格式
    function processData(data, type, scale) {
        let accumulator = 0;
        return data.map(item => {
            let x;
            switch(scale) {
                case 'year':
                    x = item.year.toString();
                    break;
                case 'month':
                    x = item.month;
                    break;
                case 'week':
                    x = `第${item.week}週`;
                    break;
                case 'day':
                    x = item.day;
                    break;
            }
            let y;
            switch(type) {
                case 'viewers':
                    y = item.total_viewers;
                    break;
                case 'sales':
                    y = item.total_sold;
                    break;
                case 'figures':
                    y = item.total_figures;
                    break;
                case 'commissions':
                    y = item.total_commission;
                    break;
            }
            accumulator += y;
            return {
                x,
                y: [accumulator, y]  // [累積值, 當前值]
            };
        });
    }

    // 創建圖表的函數
    function createChart(el, data, title, color) {
        const options = {
            series: [
                {
                    name: `${title}（累積）`,
                    type: 'area',
                    data: data.map(item => ({ x: item.x, y: item.y[0] }))
                },
                {
                    name: title,
                    type: 'column',
                    data: data.map(item => ({ x: item.x, y: item.y[1] }))
                }
            ],
            chart: {
                type: 'line',
                height: 350,
                stacked: false,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                },
                fontFamily: 'Noto Sans TC, sans-serif',
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    },
                    autoSelected: 'zoom'
                },
                zoom: {
                    enabled: true,
                    type: 'x',
                    autoScaleYaxis: true
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: [3, 0]
            },
            xaxis: {
                type: 'category',
                tickAmount: 5,
                labels: {
                    style: {
                        fontSize: '12px',
                        colors: '#666'
                    }
                }
            },
            yaxis: [
                {
                    title: {
                        text: `${title}`,
                        style: {
                            fontSize: '14px',
                            fontWeight: 500
                        }
                    },
                    labels: {
                        formatter: function (value) {
                            return value.toFixed(0);
                        },
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                {
                    opposite: true,
                    show:false,
                    title: {
                        text: title,
                        style: {
                            fontSize: '14px',
                            fontWeight: 500
                        }
                    },
                    labels: {
                        formatter: function (value) {
                            return value.toFixed(0);
                        },
                        style: {
                            fontSize: '12px'
                        }
                    }
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
                x: {
                    format: 'dd/MM/yy HH:mm'
                },
                y: {
                    formatter: function(value) {
                        return value.toFixed(0);
                    }
                }
            },
            fill: {
                type: ['gradient', 'solid'],
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.1,
                    opacityTo: 0.4,
                    stops: [0, 90, 100]
                }
            },
            colors: [color, color],
            plotOptions: {
                column: {
                    opacity: 0.7
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'left',
                fontSize: '14px'
            }
        };

        return new ApexCharts(document.querySelector(el), options);
    }

    // 更新現有圖表的函數
    function updateChart(chart, newData) {
        chart.updateSeries([
            { data: newData.map(item => ({ x: item.x, y: item.y[0] })) },  // 累積數據
            { data: newData.map(item => ({ x: item.x, y: item.y[1] })) }   // 當前值數據
        ]);
    }

    // 初始化所有圖表的非同步函數
    async function initCharts() {
        // 設置 '日' 按鈕為活動狀態
        document.getElementById('dayBtn').classList.add('active');

        const viewersData = await fetchData(apiEndpoints.viewers[currentTimeScale]);
        const salesData = await fetchData(apiEndpoints.sales[currentTimeScale]);
        const figuresData = await fetchData(apiEndpoints.figures[currentTimeScale]);
        const commissionsData = await fetchData(apiEndpoints.commissions[currentTimeScale]);

        charts.viewers = createChart('#viewersChart', processData(viewersData, 'viewers', currentTimeScale), '觀看人數', '#4a90e2');
        charts.sales = createChart('#salesChart', processData(salesData, 'sales', currentTimeScale), '銷售數量', '#f39c12');
        charts.figures = createChart('#figuresChart', processData(figuresData, 'figures', currentTimeScale), '銷售總額', '#2ecc71');
        charts.commissions = createChart('#commissionChart', processData(commissionsData, 'commissions', currentTimeScale), '佣金', '#e74c3c');

        charts.viewers.render();
        charts.sales.render();
        charts.figures.render();
        charts.commissions.render();

        updateTotalStats(viewersData, salesData, figuresData, commissionsData);
    }

    // 更新總計統計數據的函數
    function updateTotalStats(viewersData, salesData, figuresData, commissionsData) {
        let totalViewers, totalSales, totalFigures, totalCommission;

        switch(currentTimeScale) {
            case 'year':
                totalViewers = viewersData[0]?.total_viewers || 0;
                totalSales = salesData[0]?.total_sold || 0;
                totalFigures = figuresData[0]?.total_figures || 0;
                totalCommission = commissionsData[0]?.total_commission || 0;
                break;
            default:
                totalViewers = viewersData.reduce((sum, item) => sum + item.total_viewers, 0);
                totalSales = salesData.reduce((sum, item) => sum + item.total_sold, 0);
                totalFigures = figuresData.reduce((sum, item) => sum + item.total_figures, 0);
                totalCommission = commissionsData.reduce((sum, item) => sum + (item.total_commission || 0), 0);
        }

        document.getElementById('totalViewers').textContent = totalViewers.toLocaleString();
        document.getElementById('totalSales').textContent = totalSales.toLocaleString();
        document.getElementById('totalFigures').textContent = totalFigures.toLocaleString();
        document.getElementById('totalCommission').textContent = totalCommission.toLocaleString();
    }

    // 更新圖表和統計數據的非同步函數
    async function updateChartsAndStats(scale) {
        const viewersData = await fetchData(apiEndpoints.viewers[scale]);
        const salesData = await fetchData(apiEndpoints.sales[scale]);
        const figuresData = await fetchData(apiEndpoints.figures[scale]);
        const commissionsData = await fetchData(apiEndpoints.commissions[scale]);

        updateChart(charts.viewers, processData(viewersData, 'viewers', scale));
        updateChart(charts.sales, processData(salesData, 'sales', scale));
        updateChart(charts.figures, processData(figuresData, 'figures', scale));
        updateChart(charts.commissions, processData(commissionsData, 'commissions', scale));

        updateTotalStats(viewersData, salesData, figuresData, commissionsData);
    }

    // 切換時間尺度的非同步函數
    async function changeTimeScale(scale) {
        currentTimeScale = scale;
        document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${scale}Btn`).classList.add('active');

        await updateChartsAndStats(scale);
    }

    // 當 DOM 內容加載完成時初始化圖表
    document.addEventListener('DOMContentLoaded', initCharts);
</script>
</body>
</html>