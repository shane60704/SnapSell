<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舒適風格聊天室</title>
    <style>
        body {
            font-family: 'Helvetica Neue', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .chat-container {
            display: flex;
            width: 85%;
            height: 85vh;
            border-radius: 20px;
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-sidebar {
            width: 30%;
            background-color: #EAF2F7;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 2px solid #d1e0e5;
        }

        .chat-sidebar h2 {
            text-align: center;
            font-weight: bold;
            color: #4A90E2;
            margin-bottom: 20px;
        }

        .chat-room-list {
            list-style-type: none;
            padding: 0;
            flex: 1;
            overflow-y: auto;
        }

        .chat-room-list li {
            padding: 15px;
            cursor: pointer;
            margin-bottom: 12px;
            background-color: #f0f4f8;
            border-radius: 12px;
            transition: background-color 0.3s;
            color: #333;
        }

        .chat-room-list li:hover {
            background-color: #D0E7F2;
        }

        .chat-main {
            width: 70%;
            display: flex;
            flex-direction: column;
            background-color: #FAFAFA;
        }

        /* 顯示當前聊天室名稱的區塊 */
        .current-chat-room {
            padding: 20px;
            background-color: #EAF2F7;
            border-bottom: 2px solid #d1e0e5;
            color: #4A90E2;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }

        .chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #FAFAFA;
        }

        .message-area {
            display: flex;
            flex-direction: column;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message-wrapper.right {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message {
            padding: 15px;
            background-color: #F0F4F8;
            color: #333;
            border-radius: 18px;
            word-wrap: break-word; /* 過長訊息自動換行 */
            white-space: pre-wrap; /* 保留空格和換行符 */
            font-size: 15px;
            line-height: 1.5;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .message.right {
            background-color: #D0E7F2;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            background-color: #ffffff;
            border-top: 2px solid #d1e0e5;
        }

        .chat-input input {
            flex: 1;
            padding: 15px;
            border-radius: 30px;
            border: 1px solid #d1e0e5;
            background-color: #f0f4f8;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #4A90E2;
        }

        .chat-input button {
            padding: 12px 25px;
            background-color: #4A90E2;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .chat-input button:hover {
            background-color: #3a78bb;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-sidebar">
        <h2>聊天室</h2>
        <ul id="chatRoomList" class="chat-room-list"></ul>
        <button id="createChatRoomBtn" style="padding: 10px; background-color: #FF5A5F; border: none; border-radius: 30px; color: white; cursor: pointer;">新增聊天室</button>
    </div>

    <div class="chat-main">
        <!-- 顯示當前聊天室名稱的區塊 -->
        <div id="currentChatRoomName" class="current-chat-room">選擇聊天室</div>
        <div id="chatWindow" class="chat-window">
            <div id="messageArea" class="message-area"></div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="輸入訊息...">
            <button id="sendMessageBtn">發送</button>
        </div>
    </div>
</div>

<!-- 引入 SockJS 和 STOMP.js -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentChatRoomId = null;
    let currentSubscription = null; // 儲存當前的訂閱

    // 連接 WebSocket 伺服器
    function connectWebSocket() {
        const socket = new SockJS('/chat'); // 確認 WebSocket 端點為 /chat
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('已連接: ' + frame);
            const userId = getCurrentUserId(); // 從 localStorage 取得目前登入的用戶 ID
            if (userId) {
                subscribeToNewChatRoomNotifications(userId);
                loadUserChatRooms(userId); // 加載用戶的聊天室清單
            } else {
                alert("請先登入");
            }
        }, function(error) {
            console.error('連接失敗:', error);
            setTimeout(connectWebSocket, 5000); // 5 秒後重試
        });
    }

    // 訂閱新的聊天室通知
    function subscribeToNewChatRoomNotifications(userId) {
        stompClient.subscribe(`/topic/newRoom/${userId}`, function(chatRoomMessage) {
            const chatRoom = JSON.parse(chatRoomMessage.body);
            console.log("收到新聊天室通知:", chatRoom);
            addChatRoomToList(chatRoom);
        });
    }

    // 訂閱特定聊天室
    function subscribeToChatRoom(chatRoomId) {
        if (stompClient) {
            if (currentSubscription) {
                currentSubscription.unsubscribe(); // 正確取消訂閱
            }

            // 訂閱新的聊天室頻道
            currentSubscription = stompClient.subscribe(`/topic/chat/${chatRoomId}`, function(messageOutput) {
                const message = JSON.parse(messageOutput.body);
                displayMessage(message, true); // 新訊息觸發自動滾動
            });

            currentChatRoomId = chatRoomId;
        }
    }

    // 加載用戶的聊天室清單
    function loadUserChatRooms(userId) {
        fetch(`/api/1.0/users/${userId}/chatrooms`)
            .then(response => response.json())
            .then(chatRooms => {
                chatRooms.forEach(chatRoom => {
                    addChatRoomToList(chatRoom);
                });
            })
            .catch(error => console.error('加載聊天室清單失敗:', error));
    }

    // 顯示聊天室列表中的新聊天室
    function addChatRoomToList(chatRoom) {
        const chatRoomList = document.getElementById("chatRoomList");
        if (!document.querySelector(`li[data-chat-room-id="${chatRoom.id}"]`)) {
            const listItem = document.createElement("li");
            listItem.textContent = chatRoom.uniqueChatroom;
            listItem.dataset.chatRoomId = chatRoom.id;
            listItem.onclick = function() {
                joinChatRoom(chatRoom.id, chatRoom.uniqueChatroom);
            };
            chatRoomList.appendChild(listItem);
        }
    }

    // 加入聊天室並訂閱
    function joinChatRoom(chatRoomId, chatRoomName) {
        console.log("加入聊天室:", chatRoomId);
        document.getElementById('currentChatRoomName').textContent = chatRoomName; // 更新聊天室名稱
        subscribeToChatRoom(chatRoomId);
        loadChatHistory(chatRoomId); // 加載該聊天室的歷史訊息
    }

    // 加載聊天歷史記錄
    function loadChatHistory(chatRoomId) {
        fetch(`/api/1.0/chatrooms/${chatRoomId}/messages`)
            .then(response => response.json())
            .then(messages => {
                const messageArea = document.getElementById("messageArea");
                messageArea.innerHTML = ''; // 清空之前的訊息
                messages.forEach(message => {
                    displayMessage(message, false); // 加載歷史訊息不滾動
                });
                // 在加載歷史訊息後，將視窗滾動到最新的訊息
                messageArea.scrollTop = messageArea.scrollHeight;
            })
            .catch(error => console.error('加載聊天歷史失敗:', error));
    }

    // 顯示訊息
    function displayMessage(message, shouldScroll) {
        const messageArea = document.getElementById("messageArea");
        const messageWrapper = document.createElement("div");
        messageWrapper.classList.add("message-wrapper");

        // 判斷訊息發送者，將訊息顯示在不同的位置
        const userId = getCurrentUserId();
        if (message.senderId == userId) {
            messageWrapper.classList.add("right");  // 自己發送的訊息顯示在右邊
        } else {
            messageWrapper.classList.add("left");   // 對方的訊息顯示在左邊
        }

        const messageElement = document.createElement("div");
        messageElement.classList.add("message");
        messageElement.textContent = `${message.senderId}: ${message.content}`;

        const timestampElement = document.createElement("div");
        timestampElement.classList.add("timestamp");
        timestampElement.textContent = formatTimestamp(message.timestamp);

        messageWrapper.appendChild(messageElement);
        messageWrapper.appendChild(timestampElement);
        messageArea.appendChild(messageWrapper);

        // 當是新訊息時才滾動到最新
        if (shouldScroll) {
            messageWrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }

    // 發送訊息
    document.getElementById("sendMessageBtn").addEventListener("click", function() {
        const messageInput = document.getElementById("messageInput");
        const messageContent = messageInput.value.trim();
        const userId = getCurrentUserId();
        if (messageContent && stompClient && currentChatRoomId) {
            const message = {
                chatRoomId: currentChatRoomId,   // 當前聊天室 ID
                senderId: userId,                // 發送者 ID (從 localStorage 獲取)
                content: messageContent,         // 訊息內容
                timestamp: new Date().toISOString() // 當前時間
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));  // 透過 STOMP 發送訊息到後端
            messageInput.value = ''; // 清空輸入框
        } else {
            alert("請選擇聊天室並輸入訊息");
        }
    });

    // 新增聊天室按鈕
    document.getElementById("createChatRoomBtn").addEventListener("click", function() {
        const user2Id = prompt("請輸入要聊天的用戶 ID:");
        const user1Id = getCurrentUserId();
        if (user2Id && user1Id) {
            fetch(`/api/1.0/chatroom?user1Id=${user1Id}&user2Id=${user2Id}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(chatRoom => {
                    console.log("創建或獲取聊天室成功:", chatRoom);
                    addChatRoomToList(chatRoom);
                })
                .catch(error => console.error('創建聊天室失敗:', error));
        } else {
            alert("請輸入有效的用戶 ID");
        }
    });

    // 從 localStorage 獲取當前登入的用戶 ID
    function getCurrentUserId() {
        return localStorage.getItem('userId'); // 假設登入後 userId 存儲於 localStorage
    }

    // 格式化時間戳
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`; // 不顯示秒，確保分鐘兩位數
    }

    // 初始化 WebSocket 連接
    connectWebSocket();

</script>
</body>
</html>














