<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapSell | 直播間</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 上方區域（視頻和聊天區域） */
        #mainArea {
            display: flex;
            flex-grow: 1;
            margin-bottom: 20px;
        }

        /* 視訊區 */
        .video-container {
            flex: 2;
            background-color: #ddd;
            border-radius: 10px;
            position: relative;
            margin-right: 10px;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 14px;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        button {
            padding: 5px;
            border: none;
            border-radius: 3px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* 聊天區 */
        #chatArea {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: white;
        }

        #chatInput {
            display: flex;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
        }

        #sendMessage {
            padding: 10px;
            border-radius: 0 5px 5px 0;
            border: 1px solid #ddd;
        }

        /* 商品區域 */
        #products {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 0;
            border-top: 1px solid #ddd;
        }

        .product-item {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
            width: calc(33.33% - 20px); /* 3個商品並排 */
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .product-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .product-item h3 {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 10px;
        }

        .product-item p {
            font-size: 1rem;
            color: #555;
            margin: 5px 0;
        }

        /* 我要購買按鈕 */
        .buy-button {
            background-color: #28a745;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .buy-button:hover {
            background-color: #218838;
        }

        .buy-button:active {
            background-color: #1e7e34;
        }

        /* 購物彈出視窗樣式 */
        .purchase-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .purchase-modal-content {
            font-family: Arial, sans-serif;
            width: 90%;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .purchase-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .purchase-progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
            padding: 0 15px;
        }
        .purchase-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }
        .purchase-progress-step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .purchase-progress-step.active .purchase-progress-step-circle {
            background-color: #4CAF50;
            color: white;
        }
        .purchase-progress-step-name {
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .purchase-progress-line {
            position: absolute;
            top: 15px;
            left: 45px;
            right: 45px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 0;
        }

        .purchase-form-group {
            margin-bottom: 10px;
        }

        .purchase-form-row {
            display: flex;
            gap: 10px;
        }

        .purchase-form-col {
            flex: 1;
        }

        .purchase-label {
            display: block;
            margin-bottom: 3px;
            color: #666;
            font-size: 12px;
        }

        .purchase-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .purchase-input[readonly] {
            background-color: #f0f0f0;
        }

        .purchase-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
            width: 100%;
        }

        .purchase-button:hover {
            background-color: #45a049;
        }

        .purchase-summary-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* 響應式調整 */
        @media (max-width: 400px) {
            .purchase-progress-bar {
                padding: 0 5px;
            }
            .purchase-progress-step-circle {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
            .purchase-progress-step-name {
                font-size: 10px;
            }
            .purchase-progress-line {
                left: 30px;
                right: 30px;
            }
        }

        /* TapPay 表單樣式 */
        .tappay-field-focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102,175,233,.6);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102,175,233,.6);
        }

        .has-error .form-control {
            border-color: #a94442;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        }

        .has-success .form-control {
            border-color: #3c763d;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        }

        /* 整體彈出視窗樣式 */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* 半透明背景 */
            animation: fadeIn 0.5s; /* 添加淡入動畫 */
        }

        /* 彈出視窗內容容器 */
        .custom-modal-content {
            background: linear-gradient(145deg, #f0f0f0, #ffffff); /* 漸層背景 */
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            margin: 10% auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); /* 添加陰影 */
            transform: scale(0.7); /* 初始縮放效果 */
            animation: popIn 0.3s forwards; /* 添加彈出動畫 */
        }

        /* 淡入效果 */
        @keyframes fadeIn {
            from {
                background-color: rgba(0, 0, 0, 0);
            }
            to {
                background-color: rgba(0, 0, 0, 0.7);
            }
        }

        /* 彈出動畫 */
        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        /* 標題區域樣式 */
        .custom-modal-header {
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* 內文區域樣式 */
        .custom-modal-body {
            text-align: center;
            font-size: 18px;
            color: #333;
        }

        /* 彈出視窗按鈕 */
        .custom-confirm-button {
            background-color: #4CAF50; /* 按鈕顏色 */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
            display: block;
            margin: 0 auto;
        }

        .custom-confirm-button:hover {
            background-color: #45a049; /* 按鈕懸停效果 */
        }

        /* 關閉按鈕樣式 */
        .custom-close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
        }

        .custom-close-button:hover,
        .custom-close-button:focus {
            color: black;
        }

        /* 彈出視窗的底部樣式 */
        .custom-modal-footer {
            text-align: center;
            margin-top: 20px;
        }

    </style>
</head>
<body>
<div id="app">
    <!-- 上方區域 -->
    <div id="mainArea">
        <!-- 視訊區 -->
        <div class="video-container">
            <video id="videoStream" autoplay></video>
            <div class="video-label" id="videoLabel">直播中</div>
            <div id="controls">
                <button id="hangupButton" disabled>結束直播</button>
            </div>
        </div>

        <!-- 聊天區 -->
        <div id="chatArea">
            <div id="chatMessages"></div>
            <div id="chatInput">
                <input type="text" id="messageInput" placeholder="輸入訊息..." disabled>
                <button id="sendMessage" disabled>送出</button>
            </div>
        </div>
    </div>

    <!-- 狀態顯示區域 -->
    <div id="status"></div>

    <!-- 商品區域 -->
    <div id="products">
        <!-- 這裡是動態生成的商品區塊 -->
    </div>
</div>

<!-- 購物彈出視窗 -->
<div id="purchaseModal" class="purchase-modal">
    <div class="purchase-modal-content">
        <span class="purchase-close-button">&times;</span>
        <div class="purchase-progress-bar">
            <div class="purchase-progress-line"></div>
            <div class="purchase-progress-step active">
                <div class="purchase-progress-step-circle">1</div>
                <div class="purchase-progress-step-name">填寫訂單</div>
            </div>
            <div class="purchase-progress-step">
                <div class="purchase-progress-step-circle">2</div>
                <div class="purchase-progress-step-name">確認訂單</div>
            </div>
            <div class="purchase-progress-step">
                <div class="purchase-progress-step-circle">3</div>
                <div class="purchase-progress-step-name">付款</div>
            </div>
        </div>

        <!-- 第一階段：填寫訂單資訊 -->
        <div id="orderForm">
            <h2>填寫訂單資訊</h2>
            <form>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="productName">商品名稱：</label>
                        <input class="purchase-input" type="text" id="productName" name="productName" readonly>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="unitPrice">單價：</label>
                        <input class="purchase-input" type="text" id="unitPrice" name="unitPrice" readonly>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="quantity">數量：</label>
                        <input class="purchase-input" type="number" id="quantity" name="quantity" min="1" value="1">
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="totalPrice">總價：</label>
                        <input class="purchase-input" type="text" id="totalPrice" name="totalPrice" readonly>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="senderName">寄件者姓名：</label>
                        <input class="purchase-input" type="text" id="senderName" name="senderName" readonly>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="recipientName">收件者姓名：</label>
                        <input class="purchase-input" type="text" id="recipientName" name="recipientName" required>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="phone">聯絡電話：</label>
                        <input class="purchase-input" type="text" id="phone" name="phone" required>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="email">信箱：</label>
                        <input class="purchase-input" type="email" id="email" name="email" required>
                    </div>
                </div>
                <div class="purchase-form-group">
                    <label class="purchase-label" for="address">地址：</label>
                    <input class="purchase-input" type="text" id="address" name="address" required>
                </div>
                <button type="button" id="nextButton" class="purchase-button">下一步</button>
            </form>
        </div>

        <!-- 第二階段：確認訂單資訊 -->
        <div id="orderSummary" style="display:none;">
            <h2>確認訂單資訊</h2>
            <div id="summaryContent" class="purchase-summary-content"></div>
            <button type="button" id="payButton" class="purchase-button">付款</button>
        </div>

        <!-- 第三階段：付款 -->
        <div id="paymentForm" style="display:none;">
            <h2>付款資訊</h2>
            <form id="tpForm">
                <div class="form-group card-number-group">
                    <label for="card-number" class="control-label"><span id="cardtype"></span>卡號</label>
                    <div class="form-control card-number"></div>
                </div>
                <div class="form-group expiration-date-group">
                    <label for="expiration-date" class="control-label">卡片到期日</label>
                    <div class="form-control expiration-date" id="tappay-expiration-date"></div>
                </div>
                <div class="form-group ccv-group">
                    <label for="ccv" class="control-label">卡片後三碼</label>
                    <div class="form-control ccv"></div>
                </div>
                <button type="submit" class="btn btn-default pay-button">付 款</button>
            </form>
        </div>
    </div>
</div>

<!-- 付款成功彈出視窗 -->
<div id="successModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button">&times;</span>
        <div class="custom-modal-header">
            <h2>付款成功</h2>
        </div>
        <div class="custom-modal-body">
            <p>您的訂單已經完成，感謝您的購買！</p>
        </div>
        <div class="custom-modal-footer">
            <button class="custom-confirm-button">確認</button>
        </div>
    </div>
</div>

<!-- TapPay SDK -->
<script src="https://js.tappaysdk.com/sdk/tpdirect/v5.18.0"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const products = urlParams.get('products');
        const productArray = products ? products.split(',') : [];
        console.log('Selected Products:', productArray);
        // 獲取產品資料並渲染
        getProductInfo(productArray);

        function getProductInfo(productArray) {
            const productsContainer = document.getElementById('products');  // 產品渲染容器

            // 遍歷每個產品 ID，使用 fetch 獲取資料
            productArray.forEach(productId => {
                fetch(`/api/1.0/product/${productId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch product with ID ${productId}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const product = data.data;

                        // 創建 HTML 結構來顯示產品資訊
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product-item';

                        // 渲染產品詳細資料
                        productDiv.innerHTML = `
                        <img src="${product.mainImage}" alt="${product.name}" style="width: 100%; height: auto; border-radius: 8px;">
                        <h3>${product.name}</h3>
                        <p>庫存: ${product.stock}</p>
                        <p>價格: NT$ ${product.price}</p>
                        <button class="buy-button">我要購買</button>
                    `;

                        // 將產品資料添加到產品容器中
                        productsContainer.appendChild(productDiv);

                        // 處理「我要購買」按鈕點擊事件
                        const buyButton = productDiv.querySelector('.buy-button');
                        buyButton.addEventListener('click', () => {
                            initializeForm(product.name, product.price, localStorage.getItem("userName"));
                            openPurchaseModal(product);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching product:', error);
                    });
            });
        }

        // 購物彈出視窗的相關處理
        const modal = document.getElementById('purchaseModal');
        const closeButton = modal.querySelector('.purchase-close-button');
        const nextButton = document.getElementById('nextButton');
        const payButton = document.getElementById('payButton');
        let orderData = {};  // 儲存訂單資訊

        function openPurchaseModal(product) {
            modal.style.display = 'block';
            // 填寫商品資訊
            document.getElementById('productName').value = product.name;
            document.getElementById('unitPrice').value = product.price;
            document.getElementById('totalPrice').value = product.price;
            // 監聽數量變化
            document.getElementById('quantity').addEventListener('input', updateTotalPrice);
            // 初始化訂單資料
            orderData.productId = product.id;
            orderData.unitPrice = product.price;
        }

        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const unitPrice = parseInt(document.getElementById('unitPrice').value);
            document.getElementById('totalPrice').value = Math.round(quantity * unitPrice);
        }

        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
            resetModal();
        });

        nextButton.addEventListener('click', () => {
            // 驗證表單
            const requiredFields = document.querySelectorAll('#orderForm input[required]');
            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = 'red';
                } else {
                    field.style.borderColor = '';
                }
            });

            if (!isValid) {
                alert('請填寫所有必填欄位');
                return;
            }

            // 儲存訂單資料
            orderData.quantity = parseInt(document.getElementById('quantity').value) || 1;
            orderData.totalPrice = parseInt(document.getElementById('totalPrice').value);
            orderData.orderTime = new Date().toISOString();
            orderData.recipentDto = {
                name: document.getElementById('recipientName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value
            };

            // 顯示訂單摘要
            showOrderSummary();
            updateProgressBar(2);
        });

        function showOrderSummary() {
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('orderSummary').style.display = 'block';

            const summaryContent = `
                <p>商品名稱：${document.getElementById('productName').value}</p>
                <p>單價：${document.getElementById('unitPrice').value}</p>
                <p>數量：${orderData.quantity}</p>
                <p>總價：${orderData.totalPrice}</p>
                <p>寄件者姓名：${document.getElementById('senderName').value}</p>
                <p>收件者姓名：${orderData.recipentDto.name}</p>
                <p>聯絡電話：${orderData.recipentDto.phone}</p>
                <p>信箱：${orderData.recipentDto.email}</p>
                <p>地址：${orderData.recipentDto.address}</p>
    `;
            document.getElementById('summaryContent').innerHTML = summaryContent;
        }

        payButton.addEventListener('click', () => {
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'block';
            updateProgressBar(3);
            initializeTapPay();
        });

        function resetModal() {
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'none';
            document.querySelector('#orderForm form').reset();
            document.getElementById('summaryContent').innerHTML = '';
            orderData = {};
            updateProgressBar(1);
        }

        // 點擊彈出視窗外部關閉視窗
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
                resetModal();
            }
        });

        // 更新進度條
        function updateProgressBar(step) {
            const steps = document.querySelectorAll('.purchase-progress-step');
            steps.forEach((s, index) => {
                if (index < step) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
        }

        // 初始化 TapPay
        function initializeTapPay() {
            TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox')
            TPDirect.card.setup({
                fields: {
                    number: {
                        element: '.form-control.card-number',
                        placeholder: '**** **** **** ****'
                    },
                    expirationDate: {
                        element: document.getElementById('tappay-expiration-date'),
                        placeholder: 'MM / YY'
                    },
                    ccv: {
                        element: document.querySelector('.form-control.ccv'),
                        placeholder: '後三碼'
                    }
                },
                styles: {
                    'input': {
                        'color': 'gray'
                    },
                    ':focus': {
                        'color': 'black'
                    },
                    '.valid': {
                        'color': 'green'
                    },
                    '.invalid': {
                        'color': 'red'
                    }
                },
                isMaskCreditCardNumber: true,
                maskCreditCardNumberRange: {
                    beginIndex: 6,
                    endIndex: 11
                }
            });

            TPDirect.card.onUpdate(function (update) {
                if (update.canGetPrime) {
                    document.querySelector('.pay-button').removeAttribute('disabled');
                } else {
                    document.querySelector('.pay-button').setAttribute('disabled', true);
                }
            });

            document.querySelector('#tpForm').addEventListener('submit', function(event) {
                event.preventDefault();

                // 取得 TapPay Fields 的 status
                const tappayStatus = TPDirect.card.getTappayFieldsStatus();

                // 確認是否可以 getPrime
                if (tappayStatus.canGetPrime === false) {
                    alert('信用卡資訊填寫不完整');
                    return;
                }

                // Get prime
                TPDirect.card.getPrime((result) => {
                    if (result.status !== 0) {
                        alert("付款失敗，請重新付款");
                        return;
                    }
                    orderData.prime = result.card.prime;
                    orderData.userId = localStorage.getItem("userId");
                    orderData.freight = 0;
                    orderData.liveId =roomId;
                    console.log(orderData);
                    submitOrder(orderData);
                });
            });
        }


        function submitOrder(orderData) {
            fetch('/api/1.0/order/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
                .then(response => {
                    if (response.status === 200){
                        modal.style.display = 'none';
                        resetModal();
                        showSuccessModal();
                    }else{
                        throw new Error("failed");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('付款發生錯誤，請稍後再試。');
                })
        }

        // 初始化表單
        function initializeForm(productName, unitPrice, senderName) {
            document.getElementById('productName').value = productName;
            document.getElementById('unitPrice').value = unitPrice;
            document.getElementById('senderName').value = senderName;
            updateTotalPrice();
        }

        // 顯示成功彈出視窗
        // 顯示成功彈出視窗
        function showSuccessModal() {
            const successModal = document.getElementById('successModal');
            const closeButton = successModal.querySelector('.custom-close-button');
            const confirmButton = successModal.querySelector('.custom-confirm-button');

            // 顯示彈出視窗
            successModal.style.display = 'block';

            // 點擊關閉按鈕關閉彈出視窗
            closeButton.addEventListener('click', () => {
                successModal.style.display = 'none';
            });

            // 點擊「確認」按鈕關閉彈出視窗
            confirmButton.addEventListener('click', () => {
                successModal.style.display = 'none';
            });

            // 點擊視窗外部也關閉彈出視窗
            window.addEventListener('click', (event) => {
                if (event.target === successModal) {
                    successModal.style.display = 'none';
                }
            });
        }

    });

    let localStream;
    let peerConnection;
    let peerConnections = {}; // 新增：用於管理多個觀眾的連線
    let ws;
    let roomId;
    let isBroadcaster = false;
    let viewerId; // 新增：觀眾的唯一識別碼

    const configuration = {
        iceServers: [
            {urls: 'stun:stun.l.google.com:19302'},
            {
                urls: 'turn:54.238.140.240:3478',
                username: 'sean',
                credential: 'sean71507'
            }
        ]
    };

    const videoStream = document.getElementById('videoStream');
    const videoLabel = document.getElementById('videoLabel');
    const hangupButton = document.getElementById('hangupButton');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessage');

    hangupButton.onclick = hangup;
    sendMessageBtn.onclick = sendChatMessage;
    messageInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && messageInput.value.trim() !== '') {  // 檢查是否按下 Enter 鍵 且輸入框的值不為空
            sendChatMessage();  // 呼叫送出訊息的函數
        }
    });

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
        console.log(`狀態更新: ${message}`);
    }

    // 解析 URL 參數
    const urlParams = new URLSearchParams(window.location.search);
    roomId = urlParams.get('roomId');
    const role = urlParams.get('role');
    isBroadcaster = (role === 'broadcaster');

    if (!roomId || !role) {
        alert('請從大廳頁面進入房間。');
        window.location.href = 'index.html';
    } else {
        initializeWebSocket();
    }

    window.addEventListener('beforeunload', () => {
        hangup();
    });

    function initializeWebSocket() {
        // 測試環境使用
        // ws = new WebSocket('ws://localhost:8080/socket');
        // 正式環境使用
        ws = new WebSocket('wss://techwavelab.com/socket');
        console.log('正在初始化 WebSocket 連接...');

        ws.onopen = () => {
            // updateStatus('WebSocket 連接已建立');
            console.log('WebSocket 連接成功');
            if (isBroadcaster) {
                console.log('作為主播設置媒體流');
                setupMediaStream();
            } else {
                console.log('作為觀眾加入房間');
                hangupButton.style.display = "none";
                ws.send(JSON.stringify({type: 'join', roomId}));
            }
        };
        ws.onclose = () => {
            document.getElementById('status').innerHTML = '<a href="backup/live-stream-lobby-backup.html">直播已結束，請返回大廳。</a>';
            hangup();
            console.log('WebSocket 連接關閉');
        };
        ws.onerror = (error) => {
            updateStatus('WebSocket 錯誤: ' + error.message);
            console.error('WebSocket 錯誤:', error);
        };

        ws.onmessage = handleMessage;
    }

    function setupMediaStream() {
        console.log('正在獲取用戶媒體設備...');
        navigator.mediaDevices.getUserMedia({audio: true, video: true})
            .then(stream => {
                console.log('成功獲取媒體流');
                videoStream.srcObject = stream;
                videoStream.muted = true;
                localStream = stream;
                videoLabel.textContent = '直播畫面';
                // console.log('發送創建房間請求');
                // ws.send(JSON.stringify({type: 'create', roomId}));
                // 解析 URL 參數來獲取 products
                const urlParams2 = new URLSearchParams(window.location.search);
                const title = urlParams2.get('title');
                const description = urlParams2.get('description');
                const products = urlParams2.get('products');
                const productArray = products ? products.split(',') : [];

                console.log('發送創建房間請求，並附加產品數組:', productArray);

                // 發送 WebSocket 訊息，包含 roomId 和 productArray
                ws.send(JSON.stringify({
                    type: 'create',
                    roomId: roomId,
                    userId:localStorage.getItem("userId"),
                    title:title,
                    description:description,
                    products: productArray  // send product list
                }));
                hangupButton.disabled = false;
                enableChat();
            })
            .catch(e => {
                updateStatus('獲取媒體設備失敗: ' + e.message);
                console.error('獲取媒體設備失敗:', e);
            });
    }

    function handleMessage(event) {
        const message = JSON.parse(event.data);
        console.log('收到消息:', message);

        switch (message.type) {
            case 'created':
                updateStatus('房間已創建，等待觀眾加入...');
                hangupButton.disabled = false;
                enableChat();
                break;
            case 'joined':
                viewerId = message.viewerId; // 儲存 viewerId
                // updateStatus('已加入房間，等待直播開始...');
                videoLabel.textContent = '直播畫面';
                enableChat();
                break;
            case 'newViewer':
                if (isBroadcaster) {
                    console.log('新觀眾加入，創建對等連接');
                    document.getElementById('status').style.display = "none";
                    const newViewerId = message.viewerId;
                    createPeerConnection(newViewerId);
                }
                break;
            case 'offer':
                if (!isBroadcaster) {
                    handleOffer(message.offer);
                }
                break;
            case 'answer':
                if (isBroadcaster) {
                    handleAnswer(message.answer, message.viewerId);
                }
                break;
            case 'candidate':
                if (isBroadcaster) {
                    handleCandidate(message.candidate, message.viewerId);
                } else {
                    handleCandidate(message.candidate);
                }
                break;
            case 'broadcasterLeft':
                if (!isBroadcaster) {
                    document.getElementById('status').innerHTML = '<a href="backup/live-stream-lobby-backup.html">直播已結束，請返回大廳。</a>';
                    console.log('主播離開，結束連接');
                    hangup();
                }
                break;
            case 'chat':
                displayChatMessage(message.content, message.sender);
                break;
        }
    }

    function createPeerConnection(viewerId) {
        console.log('創建對等連接，觀眾 ID:', viewerId);
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnections[viewerId] = peerConnection;

        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                console.log('發送 ICE 候選項給觀眾:', viewerId);
                ws.send(JSON.stringify({
                    type: 'candidate',
                    candidate: e.candidate,
                    roomId,
                    viewerId
                }));
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE 連接狀態變更（觀眾 ID:', viewerId, '）:', peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                console.log('ICE 連接失敗或已斷開，觀眾 ID:', viewerId);
                peerConnection.close();
                delete peerConnections[viewerId];
            }
        };
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.createOffer()
            .then(offer => {
                console.log('設置本地描述，觀眾 ID:', viewerId);
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                console.log('發送連線請求給觀眾:', viewerId);
                ws.send(JSON.stringify({
                    type: 'offer',
                    offer: peerConnection.localDescription,
                    roomId,
                    viewerId
                }));
            })
            .catch(e => {
                updateStatus('創建連線請求失敗: ' + e.message);
                console.error('創建連線請求失敗:', e);
            });
    }

    function handleOffer(offer) {
        console.log('處理連線請求...');
        peerConnection = new RTCPeerConnection(configuration);
        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                console.log('發送 ICE 候選項給主播');
                ws.send(JSON.stringify({
                    type: 'candidate',
                    candidate: e.candidate,
                    roomId,
                    viewerId
                }));
            }
        };
        peerConnection.ontrack = e => {
            console.log('接收到遠程媒體軌道');
            videoStream.srcObject = e.streams[0];
        };
        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE 連接狀態變更:', peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                console.log('ICE 連接失敗或已斷開');
                hangup();  // 呼叫 hangup 函數釋放資源
            }
        };

        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => {
                console.log('創建連線回應');
                return peerConnection.createAnswer();
            })
            .then(answer => {
                console.log('設置本地描述');
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                console.log('發送連線回應給主播');
                ws.send(JSON.stringify({
                    type: 'answer',
                    answer: peerConnection.localDescription,
                    roomId,
                    viewerId
                }));
            })
            .catch(e => {
                updateStatus('處理連線請求失敗: ' + e.message);
                console.error('處理連線請求失敗:', e);
            });
    }

    function handleAnswer(answer, viewerId) {
        console.log('處理連線回應，觀眾 ID:', viewerId);
        const peerConnection = peerConnections[viewerId];
        if (peerConnection) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                .catch(e => {
                    updateStatus('設置遠端描述失敗: ' + e.message);
                    console.error('設置遠端描述失敗:', e);
                });
        } else {
            console.error('找不到對應的 peerConnection，觀眾 ID:', viewerId);
        }
    }

    function handleCandidate(candidate, viewerId) {
        if (isBroadcaster) {
            console.log('處理 ICE 候選項，觀眾 ID:', viewerId);
            const peerConnection = peerConnections[viewerId];
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(e => {
                        updateStatus('添加 ICE 候選項失敗: ' + e.message);
                        console.error('添加 ICE 候選項失敗:', e);
                    });
            } else {
                console.error('找不到對應的 peerConnection，觀眾 ID:', viewerId);
            }
        } else {
            console.log('處理 ICE 候選項');
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(e => {
                        updateStatus('添加 ICE 候選項失敗: ' + e.message);
                        console.error('添加 ICE 候選項失敗:', e);
                    });
            } else {
                console.error('peerConnection 尚未建立');
            }
        }
    }

    function hangup() {
        console.log('執行掛斷操作...');
        if (peerConnection) {
            peerConnection.onicecandidate = null;
            peerConnection.ontrack = null;
            peerConnection.oniceconnectionstatechange = null;
            peerConnection.close();
            peerConnection = null;
        }
        if (isBroadcaster) {
            for (let viewerId in peerConnections) {
                const peerConnection = peerConnections[viewerId];
                if (peerConnection) {
                    console.log('關閉對等連接，觀眾 ID:', viewerId);
                    peerConnection.close();
                }
            }
            peerConnections = {};
            window.location.href = "live-stream-lobby.html";
        } else {
            if (peerConnection) {
                console.log('關閉對等連接');
                peerConnection.close();
                peerConnection = null;
            }
        }

        if (localStream) {
            console.log('停止本地媒體串流');
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        if (ws) {
            console.log('關閉 WebSocket 連接');
            ws.close();
        }
        videoStream.srcObject = null;
        videoLabel.textContent = '';
        hangupButton.disabled = true;
        disableChat();
        updateStatus('已離開房間');
        document.getElementById('status').innerHTML = '<a href="backup/live-stream-lobby-backup.html">直播已結束，請返回大廳。</a>';
    }

    function sendChatMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (message && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'chat', content: message, roomId}));
            messageInput.value = '';
        }
    }

    // 顯示排列
    function displayChatMessage(message, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${sender}: ${message}`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 顯示群聊
    function enableChat() {
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendMessage').disabled = false;
    }

    // 隱藏群聊
    function disableChat() {
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendMessage').disabled = true;
    }

</script>
</body>
</html>