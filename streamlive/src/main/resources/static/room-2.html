<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapSell Áõ¥Êí≠Èñì</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/popup.css"/>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1C1E26;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #app {
            display: flex;
            width: 100%;
            height: 100vh;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #mainArea {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 10px;
            flex: 1.6;
        }

        .video-container {
            position: relative;
            flex: 3.5;
            background-color: #282C34;
            border-radius: 8px;
            overflow: hidden;
        }

        #status {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
        }

        #status p {
            color: white;
            font-size: 24px;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 8px 12px 8px 20px;
            border-radius: 3px;
            font-size: 14px;
        }

        .video-label::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 14px;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .viewers {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 14px;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #hangupButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* ËÅäÂ§©ÂçÄ */
        #chatArea {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            padding: 10px;
            background-color: #2C2F3F;
        }

        #messageInput,
        #sendMessage {
            border: none;
            box-shadow: none;
        }

        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #2C2F3F;
            color: white;
        }

        #chatInput {
            display: flex;
            color: #FFFFFF;
            background-color: #3C3F50;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px 0 0 5px;
            background-color: #4C4F60;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #FFFFFF;
        }

        #messageInput:focus {
            border-color: #5FB1F7;
            outline: none;
            box-shadow: 0 0 5px rgba(95, 177, 247, 0.5);
        }

        #sendMessage {
            padding: 10px;
            border-radius: 0 5px 5px 0;
            background-color: #5FB1F7;
            cursor: pointer;
            color: #FFFFFF;
            font-weight: 700;
            transition: background-color 0.3s ease;
        }

        #sendMessage:hover {
            background-color: #4C9FE4;
        }

        #products {
            border-radius: 8px;
            flex: 1.7;
            display: flex;
            gap: 10px;
            padding: 10px 0;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            background-color: #2C2F3F;
        }

        .product-item {
            background-color: #4C4F60;
            border: 1px solid #3C3F50;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            margin: 10px;
            width: calc(33.33% - 20px);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-item img {
            max-width: 100%;
            width: 120px;
            height: 110px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .product-item h3 {
            font-size: 1.4rem;
            color: #FFFFFF;
            margin: 0 0 5px 0;
        }

        .product-item p {
            font-size: 1.1rem;
            color: #AAB4CF;
            margin: 5px 0;
        }

        .buy-button {
            background-color: #4CAF50;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .buy-button:active {
            background-color: #1e7e34;
        }

        .purchase-modal {
            display: none;
            position: fixed;
            z-index: 800;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .purchase-modal-content {
            font-family: Arial, sans-serif;
            width: 90%;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .purchase-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .purchase-progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
            padding: 0 15px;
        }

        .purchase-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }

        .purchase-progress-step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .purchase-progress-step.active .purchase-progress-step-circle {
            background-color: #4CAF50;
            color: white;
        }

        .purchase-progress-step-name {
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .purchase-progress-line {
            position: absolute;
            width: 290px;
            top: 15px;
            left: 73px;
            right: 45px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 0;
        }

        .purchase-form-group {
            margin-bottom: 10px;
        }

        .purchase-form-row {
            display: flex;
            gap: 10px;
        }

        .purchase-form-col {
            flex: 1;
        }

        .purchase-label {
            display: block;
            margin-bottom: 4px;
            color: #666;
            font-size: 12px;
        }

        .purchase-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            margin-bottom: 7px;
        }

        .purchase-input[readonly] {
            background-color: #f0f0f0;
        }

        .purchase-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .purchase-button:hover {
            background-color: #45a049;
        }

        .purchase-summary-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        /* RWD */
        @media (max-width: 400px) {
            .purchase-progress-bar {
                padding: 0 5px;
            }

            .purchase-progress-step-circle {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }

            .purchase-progress-step-name {
                font-size: 10px;
            }

            .purchase-progress-line {
                left: 30px;
                right: 30px;
            }


            .modal {
                display: none;
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.7);
                animation: fadeIn 0.3s;
            }

            .modal-content {
                background-color: #0f3460;
                margin: 10% auto;
                padding: 30px;
                border: 1px solid #888;
                width: 90%;
                max-width: 500px;
                border-radius: 15px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                position: relative;
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
            }

            .close:hover,
            .close:focus {
                color: #fff;
                text-decoration: none;
                cursor: pointer;
            }

            .emoji-rating {
                display: flex;
                justify-content: space-around;
                font-size: 2em;
                margin: 20px 0;
            }

            .emoji {
                cursor: pointer;
                transition: all 0.3s ease;
                opacity: 0.5;
            }

            .emoji:hover, .emoji.active {
                transform: scale(1.2);
                opacity: 1;
            }

            #commentBox {
                width: 100%;
                height: 80px;
                padding: 10px;
                margin-top: 10px;
                border: 2px solid #e94560;
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.1);
                color: #fff;
            }

            .button-group {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
            }

            .action-btn {
                padding: 10px 20px;
                border: none;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s ease;
            }

            #submitRating {
                background-color: #e94560;
                color: white;
            }

            #skipRating {
                background-color: transparent;
                border: 2px solid #e94560;
                color: #e94560;
            }

            .gift {
                position: absolute;
                font-size: 40px;
                animation: flyGift 3s ease-out;
                opacity: 0;
            }

            @keyframes flyGift {
                0% {
                    transform: translateY(-250%) translateX(-50%);
                    opacity: 1;
                }
                80% {
                    opacity: 1;
                }
                100% {
                    transform: translateY(-350%) translateX(-50%);
                    opacity: 0;
                }
            }

            #giftModal .modal-content {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
            }

            .gift-item {
                width: 80px;
                height: 80px;
                margin: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .gift-item:hover {
                transform: scale(1.1);
            }

            .gift-icon {
                font-size: 40px;
            }

            .gift-name {
                font-size: 12px;
                margin-top: 5px;
            }
        }

        /* TapPay Ë°®ÂñÆÊ®£Âºè */
        .tappay-field-focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
        }

        .has-error .form-control {
            border-color: #a94442;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
        }

        .has-success .form-control {
            border-color: #3c763d;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
        }

        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.5s;
        }

        .custom-modal-content {
            background: linear-gradient(145deg, #f0f0f0, #ffffff); /* Êº∏Â±§ËÉåÊôØ */
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            margin: 10% auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); /* Ê∑ªÂä†Èô∞ÂΩ± */
            transform: scale(0.7); /* ÂàùÂßãÁ∏ÆÊîæÊïàÊûú */
            animation: popIn 0.3s forwards; /* Ê∑ªÂä†ÂΩàÂá∫ÂãïÁï´ */
        }

        @keyframes fadeIn {
            from {
                background-color: rgba(0, 0, 0, 0);
            }
            to {
                background-color: rgba(0, 0, 0, 0.7);
            }
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .custom-modal-header {
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .order-title {
            color: black;
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;

        }

        .custom-modal-body {
            text-align: center;
            font-size: 18px;
            color: #333;
        }

        .custom-confirm-button {
            background-color: #5FB1F7;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
            display: block;
            margin: 0 auto;
        }

        .custom-confirm-button:hover {
            background-color: #45a049;
        }

        .custom-close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 15px;
            cursor: pointer;
        }

        .margin-adjust {
            margin-top: 15px;
        }

        .custom-close-button:hover,
        .custom-close-button:focus {
            color: black;
        }

        .custom-modal-footer {
            text-align: center;
            margin-top: 20px;
        }

        .streamer-info {
            height: 90px;
            background-color: #2C2F3F;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .streamer-details {
            flex-grow: 1;
        }

        .streamer-info h2 {
            margin-top: 13px;
            margin-bottom: 4px;
            font-size: 24px;
        }

        .streamer-info p, h2 {
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #giftButton {
            background-color: #5FB1F7;
            color: white;
        }

        #exitButton, #hangupButton {
            background-color: #e94560;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
            z-index: 1000;
        }

        .modal-content {
            background-color: #0f3460;
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .adjust-btn {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s ease;
            border: none;
        }

        .adjust-btn:hover {
            background-color: #45a049;
            color: white;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 10px;
        }

        .close:hover,
        .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .emoji-rating {
            display: flex;
            justify-content: space-around;
            font-size: 2em;
            margin: 20px 0;
        }

        .emoji {
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .emoji:hover, .emoji.active {
            transform: scale(1.2);
            opacity: 1;
        }


        #commentBox {
            width: 100%;
            height: 80px;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid #e94560;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        #submitRating {
            background-color: #e94560;
            color: white;
        }

        #skipRating {
            background-color: transparent;
            border: 2px solid #e94560;
            color: #e94560;
        }

        .gift {
            position: absolute;
            font-size: 40px;
            animation: flyGift 3s ease-out;
            opacity: 0;
        }

        @keyframes flyGift {
            0% {
                transform: translateY(-150%) translateX(-50%);
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                transform: translateY(-350%) translateX(50%);
                opacity: 0;
            }
        }

        #giftModal .modal-content {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .item-container {
            display: flex;
            margin: auto;
        }

        .item-header {
            display: flex;
            margin: auto auto 10px auto;
        }

        .gift-item {
            width: 80px;
            height: 80px;
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gift-item:hover {
            transform: scale(1.1);
        }

        .gift-icon {
            font-size: 40px;
        }

        .gift-name {
            font-size: 16px;
            margin-top: 5px;
            color: white;
        }
    </style>
</head>
<body>
<div id="app">
    <div id="mainArea">
        <!-- Ë¶ñË®äÂçÄ -->
        <div class="video-container">
            <video id="videoStream" autoplay></video>
            <div class="video-label" id="videoLabel">Áõ¥Êí≠‰∏≠</div>
            <div class="viewers">Âú®Á∑ö‰∫∫Êï∏: 0</div>
            <!-- ÁãÄÊÖãÈ°ØÁ§∫ÂçÄÂüü -->
            <div id="status"></div>
        </div>
        <div class="streamer-info">
            <div class="streamer-details">
                <h2></h2>
                <p></p>
            </div>
            <div class="action-buttons">
                <button id="giftButton" class="action-button">ÈÄÅÁ¶ÆÁâ©</button>
                <button id="exitButton" class="action-button">Èõ¢ÈñãÁõ¥Êí≠</button>
                <button id="hangupButton" class="action-button" disabled>ÁµêÊùüÁõ¥Êí≠</button>
            </div>
        </div>
        <!-- ÂïÜÂìÅÂçÄÂüü -->
        <div id="products">
            <!-- ÈÄôË£°ÊòØÂãïÊÖãÁîüÊàêÁöÑÂïÜÂìÅÂçÄÂ°ä -->
        </div>
    </div>
    <!-- ËÅäÂ§©ÂçÄ -->
    <div id="chatArea">
        <div id="chatMessages"></div>
        <div id="chatInput">
            <input type="text" id="messageInput" placeholder="Ë™™Èªû‰ªÄÈ∫º..." disabled>
            <button id="sendMessage" disabled>ÈÄÅÂá∫</button>
        </div>
    </div>
</div>

<!-- Ë≥ºÁâ©ÂΩàÂá∫Ë¶ñÁ™ó -->
<div id="purchaseModal" class="purchase-modal">
    <div class="purchase-modal-content">
        <span class="purchase-close-button">&times;</span>
        <div class="purchase-progress-bar">
            <div class="purchase-progress-line"></div>
            <div class="purchase-progress-step active">
                <div class="purchase-progress-step-circle">1</div>
                <div class="purchase-progress-step-name">Â°´ÂØ´Ë®ÇÂñÆ</div>
            </div>
            <div class="purchase-progress-step">
                <div class="purchase-progress-step-circle">2</div>
                <div class="purchase-progress-step-name">Á¢∫Ë™çË®ÇÂñÆ</div>
            </div>
            <div class="purchase-progress-step">
                <div class="purchase-progress-step-circle">3</div>
                <div class="purchase-progress-step-name">‰ªòÊ¨æ</div>
            </div>
        </div>

        <!-- Á¨¨‰∏ÄÈöéÊÆµÔºöÂ°´ÂØ´Ë®ÇÂñÆË≥áË®ä -->
        <div id="orderForm">
            <p class="order-title">Â°´ÂØ´Ë®ÇÂñÆË≥áË®ä</p>
            <form>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="productName">ÂïÜÂìÅÂêçÁ®±Ôºö</label>
                        <input class="purchase-input" type="text" id="productName" name="productName" readonly>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="unitPrice">ÂñÆÂÉπÔºö</label>
                        <input class="purchase-input" type="text" id="unitPrice" name="unitPrice" readonly>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="quantity">Êï∏ÈáèÔºö</label>
                        <input class="purchase-input" type="number" id="quantity" name="quantity" min="1" value="1">
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="totalPrice">Á∏ΩÂÉπÔºö</label>
                        <input class="purchase-input" type="text" id="totalPrice" name="totalPrice" readonly>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="senderName">‰∏ãÂñÆËÄÖÂßìÂêçÔºö</label>
                        <input class="purchase-input" type="text" id="senderName" name="senderName" readonly>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="recipientName">Êî∂‰ª∂ËÄÖÂßìÂêçÔºö</label>
                        <input class="purchase-input" type="text" id="recipientName" name="recipientName" required>
                    </div>
                </div>
                <div class="purchase-form-row">
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="phone">ËÅØÁµ°ÈõªË©±Ôºö</label>
                        <input class="purchase-input" type="text" id="phone" name="phone" required>
                    </div>
                    <div class="purchase-form-col">
                        <label class="purchase-label" for="email">‰ø°ÁÆ±Ôºö</label>
                        <input class="purchase-input" type="email" id="email" name="email" required>
                    </div>
                </div>
                <div class="purchase-form-group">
                    <label class="purchase-label" for="address">Âú∞ÂùÄÔºö</label>
                    <input class="purchase-input" type="text" id="address" name="address" required>
                </div>
                <button type="button" id="nextButton" class="purchase-button">‰∏ã‰∏ÄÊ≠•</button>
            </form>
        </div>

        <!-- Á¨¨‰∫åÈöéÊÆµÔºöÁ¢∫Ë™çË®ÇÂñÆË≥áË®ä -->
        <div id="orderSummary" style="display:none;">
            <p class="order-title">Á¢∫Ë™çË®ÇÂñÆË≥áË®ä</p>
            <div id="summaryContent" class="purchase-summary-content"></div>
            <button type="button" id="payButton" class="purchase-button margin-adjust">ÁµêÂ∏≥</button>
        </div>

        <!-- Á¨¨‰∏âÈöéÊÆµÔºö‰ªòÊ¨æ -->
        <div id="paymentForm" style="display:none;">
            <p class="order-title">‰ªòÊ¨æË≥áË®ä</p>
            <form id="tpForm">
                <div class="form-group card-number-group">
                    <label for="card-number" class="control-label"><span id="cardtype"></span>Âç°Ëôü</label>
                    <div class="form-control card-number"></div>
                </div>
                <div class="form-group expiration-date-group">
                    <label for="expiration-date" class="control-label">Âç°ÁâáÂà∞ÊúüÊó•</label>
                    <div class="form-control expiration-date" id="tappay-expiration-date"></div>
                </div>
                <div class="form-group ccv-group">
                    <label for="ccv" class="control-label">Âç°ÁâáÂæå‰∏âÁ¢º</label>
                    <div class="form-control ccv"></div>
                </div>
                <button type="submit" class="btn btn-default pay-button adjust-btn">‰ªòÊ¨æ</button>
            </form>
        </div>
    </div>
</div>

<!-- ‰ªòÊ¨æÊàêÂäüÂΩàÂá∫Ë¶ñÁ™ó -->
<div id="successModal" class="custom-modal">
    <div class="custom-modal-content">
        <span class="custom-close-button">&times;</span>
        <div class="custom-modal-header">
            <p class="order-title">‰ªòÊ¨æÊàêÂäü</p>
        </div>
        <div class="custom-modal-body">
            <p>ÊÇ®ÁöÑË®ÇÂñÆÂ∑≤Á∂ìÂÆåÊàêÔºåÊÑüË¨ùÊÇ®ÁöÑË≥ºË≤∑ÔºÅ</p>
        </div>
        <div class="custom-modal-footer">
            <button class="custom-confirm-button">Á¢∫Ë™ç</button>
        </div>
    </div>
</div>

<!-- ‰ªòÊ¨æÁãÄÊÖãÂΩàÂá∫Ë¶ñÁ™ó -->
<div class="popup-overlay" id="successPopup">
    <div class="popup success">
        <div class="popup-icon">
            <svg viewBox="0 0  100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#E8F5E9"/>
                <circle cx="50" cy="50" r="35" fill="#4CAF50"/>
                <path d="M40 50 L47 57 L60 44" stroke="white" stroke-width="6" fill="none"/>
            </svg>
        </div>
        <div class="popup-title">‰ªòÊ¨æÊàêÂäü</div>
        <div class="popup-message">ÊÇ®ÁöÑË®ÇÂñÆÂ∑≤ÊàêÁ´ãÔºåÊÑüË¨ùË≥ºË≤∑ÔºÅ</div>
        <button class="popup-button" onclick="closeResultPopup('successPopup')">Á¢∫ÂÆö</button>
    </div>
</div>
<div class="popup-overlay" id="failurePopup">
    <div class="popup failure">
        <div class="popup-icon">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#FFEBEE"/>
                <circle cx="50" cy="50" r="35" fill="#F44336"/>
                <path d="M35 35 L65 65 M65 35 L35 65" stroke="white" stroke-width="6" fill="none"/>
            </svg>
        </div>
        <div class="popup-title">‰ªòÊ¨æÂ§±Êïó</div>
        <div class="popup-message">ÂæàÊä±Ê≠âÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑ‰ø°Áî®Âç°Ë≥áË®äÔºåÁ®çÂæåÂÜçË©¶„ÄÇ</div>
        <button class="popup-button" onclick="closeResultPopup('failurePopup')">ÈóúÈñâ</button>
    </div>
</div>

<!-- Ë©ïÂàÜÂΩàÂá∫Ë¶ñÁ™ó-->
<div id="ratingModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Áõ¥Êí≠ÁµêÊùüÔºÅË¥àÈÄÅÁ¶ÆÁâ©Ë©ïÂàÜÂêßÔºÅ</h2>
        <div class="emoji-rating">
            <span class="emoji" data-rating="1">üò¢</span>
            <span class="emoji" data-rating="2">üòê</span>
            <span class="emoji" data-rating="3">üòä</span>
            <span class="emoji" data-rating="4">üòÑ</span>
            <span class="emoji" data-rating="5">ü•∞</span>
        </div>
        <textarea id="commentBox" placeholder="Ë™™Ë™™ÁúãÁõ¥Êí≠Âì™Ë£°Á≤æÂΩ©ÔºüÊàñÊòØÊúâ‰ªÄÈ∫ºÂª∫Ë≠∞Âë¢Ôºü"></textarea>
        <div class="button-group">
            <button id="submitRating" class="action-btn">ÈÄÅÂá∫Ë©ïÂÉπ</button>
            <button id="skipRating" class="action-btn">‰∏ãÊ¨°ÂÜçË™™</button>
        </div>
    </div>
</div>

<!-- Á¶ÆÁâ©ÂΩàÂá∫Ë¶ñÁ™ó-->
<div id="giftModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="item-header">
            <h2>ÈÅ∏ÊìáÁ¶ÆÁâ©</h2>
        </div>
        <div class="item-container">
            <div class="gift-item" onclick="sendGift('üåπ')">
                <div class="gift-icon">üåπ</div>
                <div class="gift-name">Áé´Áë∞</div>
            </div>
            <div class="gift-item" onclick="sendGift('üéÅ')">
                <div class="gift-icon">üéÅ</div>
                <div class="gift-name">Á¶ÆÁâ©</div>
            </div>
            <div class="gift-item" onclick="sendGift('üíé')">
                <div class="gift-icon">üíé</div>
                <div class="gift-name">ÈëΩÁü≥</div>
            </div>
            <div class="gift-item" onclick="sendGift('üöÄ')">
                <div class="gift-icon">üöÄ</div>
                <div class="gift-name">ÁÅ´ÁÆ≠</div>
            </div>
        </div>
    </div>
</div>

<!-- TapPay SDK -->
<script src="https://js.tappaysdk.com/sdk/tpdirect/v5.18.0"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="assets/js/popup.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const products = urlParams.get('products');
        const title = urlParams.get('title');
        const productArray = products ? products.split(',') : [];
        const description = urlParams.get('description');
        console.log('Selected Products:', productArray);

        getProductInfo(productArray);
        document.querySelector('.streamer-details h2').textContent = `‰∏ªÊí≠ : ${description}`;
        document.querySelector('.streamer-details p').textContent = `Ê≠£Âú®Áõ¥Êí≠Ôºö${title}`;

        function getProductInfo(productArray) {
            const productsContainer = document.getElementById('products');

            // ÈÅçÊ≠∑ÊØèÂÄãÁî¢ÂìÅ IDÔºå‰ΩøÁî® fetch Áç≤ÂèñË≥áÊñô
            productArray.forEach(productId => {
                fetch(`/api/1.0/product/${productId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch product with ID ${productId}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const product = data.data;

                        const productDiv = document.createElement('div');
                        productDiv.className = 'product-item';
                        const mainImage = product.mainImage || 'https://via.placeholder.com/300';
                        productDiv.innerHTML = `
                        <img src="${mainImage}" alt="${product.name}" >
                        <h3>${product.name}</h3>
                        <p>ÂÉπÊ†º: NT$ ${product.price}</p>
                        <button class="buy-button">Á´ãÂç≥Ë≥ºË≤∑</button>
                    `;

                        productsContainer.appendChild(productDiv);

                        const buyButton = productDiv.querySelector('.buy-button');
                        buyButton.addEventListener('click', () => {
                            initializeForm(product.name, product.price, localStorage.getItem("userName"));
                            openPurchaseModal(product);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching product:', error);
                    });
            });
        }

        // Ë≥ºÁâ©ÂΩàÂá∫Ë¶ñÁ™óÁöÑÁõ∏ÈóúËôïÁêÜ
        const modal = document.getElementById('purchaseModal');
        const closeButton = modal.querySelector('.purchase-close-button');
        const nextButton = document.getElementById('nextButton');
        const payButton = document.getElementById('payButton');
        let orderData = {};  // ÂÑ≤Â≠òË®ÇÂñÆË≥áË®ä

        function openPurchaseModal(product) {
            modal.style.display = 'block';
            // Â°´ÂØ´ÂïÜÂìÅË≥áË®ä
            document.getElementById('productName').value = product.name;
            document.getElementById('unitPrice').value = product.price;
            document.getElementById('totalPrice').value = product.price;
            // Áõ£ËÅΩÊï∏ÈáèËÆäÂåñ
            document.getElementById('quantity').addEventListener('input', updateTotalPrice);
            // ÂàùÂßãÂåñË®ÇÂñÆË≥áÊñô
            orderData.productId = product.id;
            // orderData.unitPrice = product.price;
        }

        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const unitPrice = parseInt(document.getElementById('unitPrice').value);
            document.getElementById('totalPrice').value = Math.round(quantity * unitPrice);
        }

        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
            resetModal();
        });

        nextButton.addEventListener('click', () => {
            // È©óË≠âË°®ÂñÆ
            const requiredFields = document.querySelectorAll('#orderForm input[required]');
            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = 'red';
                } else {
                    field.style.borderColor = '';
                }
            });

            if (!isValid) {
                alert('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                return;
            }

            // ÂÑ≤Â≠òË®ÇÂñÆË≥áÊñô
            orderData.quantity = parseInt(document.getElementById('quantity').value) || 1;
            orderData.totalPrice = parseInt(document.getElementById('totalPrice').value);
            orderData.orderTime = new Date().toISOString();
            orderData.recipentDto = {
                name: document.getElementById('recipientName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value
            };

            // È°ØÁ§∫Ë®ÇÂñÆÊëòË¶Å
            showOrderSummary();
            updateProgressBar(2);
        });

        function showOrderSummary() {
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('orderSummary').style.display = 'block';

            const summaryContent = `
                <p>ÂïÜÂìÅÂêçÁ®±Ôºö${document.getElementById('productName').value}</p>
                <p>ÂñÆÂÉπÔºö${document.getElementById('unitPrice').value}</p>
                <p>Êï∏ÈáèÔºö${orderData.quantity}</p>
                <p>Á∏ΩÂÉπÔºö${orderData.totalPrice}</p>
                <p>ÂØÑ‰ª∂ËÄÖÂßìÂêçÔºö${document.getElementById('senderName').value}</p>
                <p>Êî∂‰ª∂ËÄÖÂßìÂêçÔºö${orderData.recipentDto.name}</p>
                <p>ËÅØÁµ°ÈõªË©±Ôºö${orderData.recipentDto.phone}</p>
                <p>‰ø°ÁÆ±Ôºö${orderData.recipentDto.email}</p>
                <p>Âú∞ÂùÄÔºö${orderData.recipentDto.address}</p>
    `;
            document.getElementById('summaryContent').innerHTML = summaryContent;
        }

        payButton.addEventListener('click', () => {
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'block';
            updateProgressBar(3);
            initializeTapPay();
        });

        function resetModal() {
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'none';
            document.querySelector('#orderForm form').reset();
            document.getElementById('summaryContent').innerHTML = '';
            orderData = {};
            updateProgressBar(1);
        }

        // ÈªûÊìäÂΩàÂá∫Ë¶ñÁ™óÂ§ñÈÉ®ÈóúÈñâË¶ñÁ™ó
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
                resetModal();
            }
        });

        // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
        function updateProgressBar(step) {
            const steps = document.querySelectorAll('.purchase-progress-step');
            steps.forEach((s, index) => {
                if (index < step) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
        }

        // ÂàùÂßãÂåñ TapPay
        function initializeTapPay() {
            TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox')
            TPDirect.card.setup({
                fields: {
                    number: {
                        element: '.form-control.card-number',
                        placeholder: '**** **** **** ****'
                    },
                    expirationDate: {
                        element: document.getElementById('tappay-expiration-date'),
                        placeholder: 'MM / YY'
                    },
                    ccv: {
                        element: document.querySelector('.form-control.ccv'),
                        placeholder: 'Âæå‰∏âÁ¢º'
                    }
                },
                styles: {
                    'input': {
                        'color': 'gray'
                    },
                    ':focus': {
                        'color': 'black'
                    },
                    '.valid': {
                        'color': 'green'
                    },
                    '.invalid': {
                        'color': 'red'
                    }
                },
                isMaskCreditCardNumber: true,
                maskCreditCardNumberRange: {
                    beginIndex: 6,
                    endIndex: 11
                }
            });

            TPDirect.card.onUpdate(function (update) {
                if (update.canGetPrime) {
                    document.querySelector('.pay-button').removeAttribute('disabled');
                } else {
                    document.querySelector('.pay-button').setAttribute('disabled', true);
                }
            });

            document.querySelector('#tpForm').addEventListener('submit', function (event) {
                event.preventDefault();

                const tappayStatus = TPDirect.card.getTappayFieldsStatus();

                if (tappayStatus.canGetPrime === false) {
                    alert('‰ø°Áî®Âç°Ë≥áË®äÂ°´ÂØ´‰∏çÂÆåÊï¥');
                    return;
                }

                TPDirect.card.getPrime((result) => {
                    if (result.status !== 0) {
                        alert("‰ªòÊ¨æÂ§±ÊïóÔºåË´ãÈáçÊñ∞‰ªòÊ¨æ");
                        return;
                    }
                    orderData.prime = result.card.prime;
                    orderData.userId = localStorage.getItem("userId");
                    orderData.freight = 0;
                    orderData.liveId = roomId;
                    console.log(orderData);
                    submitOrder(orderData);
                });
            });
        }


        function submitOrder(orderData) {
            fetch('/api/1.0/order/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
                .then(response => {
                    if (response.status === 200) {
                        modal.style.display = 'none';
                        resetModal();
                        showResultPopup('successPopup');
                    } else {
                        throw new Error("failed");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showResultPopup('failurePopup');
                })
        }

        function initializeForm(productName, unitPrice, senderName) {
            document.getElementById('productName').value = productName;
            document.getElementById('unitPrice').value = unitPrice;
            document.getElementById('senderName').value = senderName;
            updateTotalPrice();
        }

    });

    let localStream;
    let peerConnections = {};
    let ws;
    let signalingWs;
    let roomId;
    let isBroadcaster = false;
    let viewerId;

    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            {
                urls: 'turn:54.238.140.240:3478',
                username: 'sean',
                credential: 'sean71507'
            }
        ]
    };

    const videoStream = document.getElementById('videoStream');
    const videoLabel = document.getElementById('videoLabel');
    const hangupButton = document.getElementById('hangupButton');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessage');
    const giftButton = document.getElementById('giftButton');
    const exitButton = document.getElementById('exitButton');
    const ratingModal = document.getElementById("ratingModal");
    const giftModal = document.getElementById("giftModal");
    const exitBtn = document.getElementById("exitButton");
    const giftBtn = document.getElementById("giftButton");
    const closeBtns = document.getElementsByClassName("close");
    const emojis = document.querySelectorAll(".emoji");
    const submitBtn = document.getElementById("submitRating");
    const skipBtn = document.getElementById("skipRating");
    const statusDiv = document.getElementById('status');

    statusDiv.style.display = "none";
    let currentRating = 0;

    exitBtn.onclick = function () {
        ratingModal.style.display = "block";
    }

    giftBtn.onclick = function () {
        giftModal.style.display = "block";
    }

    for (let closeBtn of closeBtns) {
        closeBtn.onclick = function () {
            ratingModal.style.display = "none";
            giftModal.style.display = "none";
        }
    }

    window.onclick = function (event) {
        if (event.target == ratingModal || event.target == giftModal) {
            ratingModal.style.display = "none";
            giftModal.style.display = "none";
        }
    }

    emojis.forEach((emoji) => {
        emoji.addEventListener("click", (e) => {
            currentRating = e.target.getAttribute("data-rating");
            emojis.forEach((em) => {
                em.classList.remove("active");
                if (em.getAttribute("data-rating") <= currentRating) {
                    em.classList.add("active");
                }
            });
        });
    });

    submitBtn.onclick = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const comment = document.getElementById("commentBox").value;
        const satisfactionDto = {
            userId: localStorage.getItem("userId"),
            liveId: urlParams.get('roomId'),
            score: currentRating,
            comment: comment
        };
        fetch("/api/1.0/livestream/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(satisfactionDto)
        })
            .then(response => response.json())
            .then(data => {
                console.log("Success:", data);
            })
            .catch((error) => {
                console.error("Error:", error);
            });
        console.log(`Rating: ${currentRating}, Comment: ${comment}`);
        alert("ÊÑüË¨ùÊÇ®ÁöÑË©ïÂÉπÔºÅÊÇ®ÁöÑÊÑèË¶ãÂ∞çÊàëÂÄëÂæàÈáçË¶Å„ÄÇ");
        ratingModal.style.display = "none";
        hangup();
        window.location.href = "live-stream-lobby.html";
    }

    skipBtn.onclick = function () {
        ratingModal.style.display = "none";
        hangup();
        window.location.href = "live-stream-lobby.html";
    }

    hangupButton.onclick = hangup;
    sendMessageBtn.onclick = sendChatMessage;
    messageInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && messageInput.value.trim() !== '') {
            sendChatMessage();
        }
    });

    function updateStatus(message) {
        document.getElementById('status').textContent = message;
        console.log(`ÁãÄÊÖãÊõ¥Êñ∞: ${message}`);
    }

    const urlParams = new URLSearchParams(window.location.search);
    roomId = urlParams.get('roomId');
    const role = urlParams.get('role');
    isBroadcaster = (role === 'broadcaster');

    if (!roomId || !role) {
        alert('Ë´ãÂæûÂ§ßÂª≥È†ÅÈù¢ÈÄ≤ÂÖ•ÊàøÈñì„ÄÇ');
        window.location.href = 'index.html';
    } else {
        initializeWebSocket();
    }

    window.addEventListener('beforeunload', () => {
        hangup();
    });

    function initializeWebSocket() {
        const userId = localStorage.getItem("userId");
        if (!userId) {
            alert("Áî®Êà∂Êú™ÁôªÈåÑÔºÅ");
            window.location.href = "login.html";
            return;
        }

        // ‰∏ª WebSocket ÈÄ£Êé•ÔºàËôïÁêÜÊ•≠ÂãôÁõ∏ÈóúÊ∂àÊÅØÔºåÂ¶ÇËÅäÂ§©ÂÆ§„ÄÅÁ¶ÆÁâ©Á≠âÔºâ
        ws = new WebSocket('ws://localhost:8080/socket'); // Ê∏¨Ë©¶Áí∞Â¢É
        // ws = new WebSocket('wss://techwavelab.com/socket'); // Ê≠£ÂºèÁí∞Â¢É‰ΩøÁî®
        console.log('Ê≠£Âú®ÂàùÂßãÂåñ main service websocket ÈÄ£Êé•...');

        ws.onopen = () => {
            console.log('Main WebSocket ÈÄ£Êé•ÊàêÂäü');
            if (isBroadcaster) {
                console.log('‰ΩúÁÇ∫‰∏ªÊí≠Ë®≠ÁΩÆÂ™íÈ´îÊµÅ');
                document.getElementById("products").style.display = "none";
                exitButton.style.display = "none";
                giftButton.style.display = "none";
                setupMediaStream();
            } else {
                console.log('‰ΩúÁÇ∫ËßÄÁúæÂä†ÂÖ•ÊàøÈñì');
                hangupButton.style.display = "none";
                ws.send(JSON.stringify({ type: 'join', roomId, userId }));
            }
        };
        ws.onclose = () => {
            document.getElementById('status').innerHTML = '<p>Áõ¥Êí≠Â∑≤ÁµêÊùü„ÄÇ</p>';
            hangup();
            console.log('Main WebSocket ÈÄ£Êé•ÈóúÈñâ');
        };
        ws.onerror = (error) => {
            updateStatus('Main WebSocket ÈåØË™§: ' + error.message);
            console.error('Main WebSocket ÈåØË™§:', error);
        };

        ws.onmessage = handleMainMessage;

        // Signaling WebSocket ÈÄ£Êé•ÔºàËôïÁêÜ WebRTC ‰ø°‰ª§Ê∂àÊÅØÔºâ
        signalingWs = new WebSocket('ws://localhost:3000/signaling'); // Ê∏¨Ë©¶Áí∞Â¢É
        // signalingWs = new WebSocket('wss://seanlife.site/signaling'); //Ê≠£ÂºèÁí∞Â¢É
        console.log('Ê≠£Âú®ÂàùÂßãÂåñ signaling service websocket ÈÄ£Êé•...');
        signalingWs.onopen = () => {
            console.log('Signaling WebSocket ÈÄ£Êé•ÊàêÂäü');
            signalingWs.send(JSON.stringify({
                type: 'identify',
                userId: userId,
                roomId: roomId,
                role: isBroadcaster ? 'broadcaster' : 'viewer'
            }));
        }
        signalingWs.onclose = () => {
            console.log('Signaling WebSocket ÈÄ£Êé•ÈóúÈñâ');
        };
        signalingWs.onerror = (error) => {
            console.error('Signaling WebSocket ÈåØË™§:', error);
        };

        signalingWs.onmessage = handleSignalingMessage;
    }

    function handleMainMessage(event) {
        const message = JSON.parse(event.data);
        console.log('Êî∂Âà∞ Main WebSocket Ê∂àÊÅØ:', message);

        switch (message.type) {
            case 'created':
                updateStatus('ÊàøÈñìÂ∑≤ÂâµÂª∫ÔºåÁ≠âÂæÖËßÄÁúæÂä†ÂÖ•...');
                hangupButton.disabled = false;
                enableChat();
                break;
            case 'joined':
                viewerId = message.viewerId;
                videoLabel.textContent = 'Áõ¥Êí≠Áï´Èù¢';
                enableChat();
                break;
            case 'newViewer':
                if (isBroadcaster) {
                    console.log('Êñ∞ËßÄÁúæÂä†ÂÖ•ÔºåÂâµÂª∫Â∞çÁ≠âÈÄ£Êé•');
                    document.getElementById('status').style.display = "none";
                    const newViewerId = message.viewerId;
                    createPeerConnection(newViewerId);
                }
                break;
            case 'broadcasterLeft':
                if (!isBroadcaster) {
                    document.getElementById('status').innerHTML = '<p>Áõ¥Êí≠Â∑≤ÁµêÊùüÔºåË´ãËøîÂõûÂ§ßÂª≥„ÄÇ</p>';
                    console.log('‰∏ªÊí≠Èõ¢ÈñãÔºåÁµêÊùüÈÄ£Êé•');
                    hangup();
                }
                break;
            case 'viewerLeft':
                console.log(`ËßÄÁúæ ${message.viewerId} Â∑≤Èõ¢ÈñãÊàøÈñì`);
                removePeerConnection(message.viewerId);
                break;
            case 'viewerCountUpdate':
                updateViewerCount(message.viewerCount);
                break;
            case 'chat':
                displayChatMessage(message.content, message.sender);
                break;
            case 'gift':
                showGiftAnimation(message.sender, message.gift);
                const giftMessage = `${message.sender} ÈÄÅÂá∫‰∫Ü‰∏ÄÂÄã ${message.gift} Á¶ÆÁâ©ÔºÅ`;
                displayChatMessage(giftMessage, 'Á≥ªÁµ±');
                break;
            default:
                console.log("Êú™Áü•ÁöÑ Main WebSocket Ê∂àÊÅØÈ°ûÂûã:", message.type);
        }
    }

    function handleSignalingMessage(event) {
        const message = JSON.parse(event.data);
        console.log('Êî∂Âà∞ Signaling Ê∂àÊÅØ:', message);

        switch (message.type) {
            case 'offer':
                if (!isBroadcaster) {
                    handleOffer(message.offer, message.userId);
                }
                break;
            case 'answer':
                if (isBroadcaster) {
                    handleAnswer(message.answer, message.userId);
                }
                break;
            case 'candidate':
                if (isBroadcaster) {
                    handleCandidate(message.candidate, message.userId);
                } else {
                    handleCandidate(message.candidate, message.userId);
                }
                break;
            default:
                console.log("Êú™Áü•ÁöÑ Signaling Ê∂àÊÅØÈ°ûÂûã:", message.type);
        }
    }

    // Âª∫Á´ãÈÄ£Á∑ö
    function createPeerConnection(newViewerUserId) {
        console.log('ÂâµÂª∫Â∞çÁ≠âÈÄ£Êé•ÔºåËßÄÁúæ User ID:', newViewerUserId);
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnections[newViewerUserId] = peerConnection;

        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                console.log('ÁôºÈÄÅ ICE ÂÄôÈÅ∏È†ÖÁµ¶ËßÄÁúæ:', newViewerUserId);
                sendSignalingMessage({
                    type: 'candidate',
                    candidate: e.candidate,
                    roomId: roomId,
                    viewerId: newViewerUserId // ‰ΩøÁî® viewer ÁöÑ userId
                });
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE ÈÄ£Êé•ÁãÄÊÖãËÆäÊõ¥ÔºàËßÄÁúæ User ID:', newViewerUserId, 'Ôºâ:', peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                console.log('ICE ÈÄ£Êé•Â§±ÊïóÊàñÂ∑≤Êñ∑ÈñãÔºåËßÄÁúæ User ID:', newViewerUserId);
                peerConnection.close();
                delete peerConnections[newViewerUserId];
            }
        };

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.createOffer()
            .then(offer => {
                console.log('Ë®≠ÁΩÆÊú¨Âú∞ÊèèËø∞ÔºåËßÄÁúæ User ID:', newViewerUserId);
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                console.log('ÁôºÈÄÅÈÄ£Á∑öË´ãÊ±ÇÁµ¶ËßÄÁúæ:', newViewerUserId);
                sendSignalingMessage({
                    type: 'offer',
                    offer: peerConnection.localDescription,
                    roomId: roomId,
                    viewerId: newViewerUserId
                });
            })
            .catch(e => {
                updateStatus('ÂâµÂª∫ÈÄ£Á∑öË´ãÊ±ÇÂ§±Êïó: ' + e.message);
                console.error('ÂâµÂª∫ÈÄ£Á∑öË´ãÊ±ÇÂ§±Êïó:', e);
            });
    }

    // Ê∏ÖÈô§ÈÄ£Á∑öÈáãÊîæË≥áÊ∫ê
    function removePeerConnection(viewerUserId) {
        const peerConnection = peerConnections[viewerUserId];
        if (peerConnection) {
            peerConnection.close();
            delete peerConnections[viewerUserId];
            console.log(`Â∑≤ÈáãÊîæËßÄÁúæ ${viewerUserId} ÁöÑÈÄ£Á∑öË≥áÊ∫ê`);
        }
    }

    function updateViewerCount(viewerCount) {
        const viewersElement = document.querySelector('.viewers');
        viewersElement.textContent = `Âú®Á∑ö‰∫∫Êï∏: ${viewerCount}`;
    }

    function handleOffer(offer, senderUserId) {
        console.log('ËôïÁêÜÈÄ£Á∑öË´ãÊ±Ç...');
        const peerConnection = new RTCPeerConnection(configuration);
        peerConnections[senderUserId] = peerConnection;

        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                sendSignalingMessage({
                    type: 'candidate',
                    candidate: e.candidate,
                    roomId: roomId,
                    viewerId: senderUserId
                });
            }
        };

        peerConnection.ontrack = e => {
            console.log('Êé•Êî∂Âà∞ÈÅ†Á®ãÂ™íÈ´îËªåÈÅì');
            videoStream.srcObject = e.streams[0];
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE ÈÄ£Êé•ÁãÄÊÖãËÆäÊõ¥:', peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                console.log('ICE ÈÄ£Êé•Â§±ÊïóÊàñÂ∑≤Êñ∑Èñã');
                hangup();
            }
        };

        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => {
                console.log('ÂâµÂª∫ÈÄ£Á∑öÂõûÊáâ');
                return peerConnection.createAnswer();
            })
            .then(answer => {
                console.log('Ë®≠ÁΩÆÊú¨Âú∞ÊèèËø∞');
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                console.log('ÁôºÈÄÅÈÄ£Á∑öÂõûÊáâÁµ¶‰∏ªÊí≠');
                sendSignalingMessage({
                    type: 'answer',
                    answer: peerConnection.localDescription,
                    roomId: roomId,
                    viewerId: senderUserId
                });
            })
            .catch(e => {
                updateStatus('ËôïÁêÜÈÄ£Á∑öË´ãÊ±ÇÂ§±Êïó: ' + e.message);
                console.error('ËôïÁêÜÈÄ£Á∑öË´ãÊ±ÇÂ§±Êïó:', e);
            });
    }

    function handleAnswer(answer, senderUserId) {
        console.log('ËôïÁêÜÈÄ£Á∑öÂõûÊáâÔºåËßÄÁúæ User ID:', senderUserId);
        const peerConnection = peerConnections[senderUserId];
        if (peerConnection) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                .catch(e => {
                    updateStatus('Ë®≠ÁΩÆÈÅ†Á´ØÊèèËø∞Â§±Êïó: ' + e.message);
                    console.error('Ë®≠ÁΩÆÈÅ†Á´ØÊèèËø∞Â§±Êïó:', e);
                });
        } else {
            console.error('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑ peerConnectionÔºåËßÄÁúæ User ID:', senderUserId);
        }
    }

    function handleCandidate(candidate, senderUserId) {
        const peerConnection = peerConnections[senderUserId];
        if (peerConnection) {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                .catch(e => {
                    updateStatus('Ê∑ªÂä† ICE ÂÄôÈÅ∏È†ÖÂ§±Êïó: ' + e.message);
                    console.error('Ê∑ªÂä† ICE ÂÄôÈÅ∏È†ÖÂ§±Êïó:', e);
                });
        } else {
            console.error('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑ peerConnectionÔºåËßÄÁúæ User ID:', senderUserId);
        }
    }

    function hangup() {
        console.log('Âü∑Ë°åÊéõÊñ∑Êìç‰Ωú...');
        for (let viewerId in peerConnections) {
            const peerConnection = peerConnections[viewerId];
            if (peerConnection) {
                console.log('ÈóúÈñâÂ∞çÁ≠âÈÄ£Êé•ÔºåËßÄÁúæ ID:', viewerId);
                peerConnection.close();
            }
        }
        peerConnections = {};
        if (isBroadcaster) {
            window.location.href = "live-stream-lobby.html";
        }

        if (localStream) {
            console.log('ÂÅúÊ≠¢Êú¨Âú∞Â™íÈ´î‰∏≤ÊµÅ');
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('ÈóúÈñâ‰∏ª WebSocket ÈÄ£Êé•');
            ws.close();
        }

        if (signalingWs && signalingWs.readyState === WebSocket.OPEN) {
            console.log('ÈóúÈñâ Signaling WebSocket ÈÄ£Êé•');
            signalingWs.close();
        }

        videoStream.srcObject = null;
        videoLabel.textContent = '';
        videoLabel.style.display = 'none';
        hangupButton.disabled = true;
        disableChat();

        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = '<p>Áõ¥Êí≠Â∑≤ÁµêÊùü</p>';
        statusDiv.style.display = 'flex';
        statusDiv.style.color = 'white';

        document.getElementById("videoLabel").style.display = "none";
        document.querySelector(".viewers").style.display = "none";

    }

    function sendChatMessage() {
        const message = messageInput.value.trim();
        if (message && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'chat', content: message, roomId }));
            messageInput.value = '';
        }
    }

    function sendGift(giftEmoji) {
        const sender = localStorage.getItem('userName');
        giftModal.style.display = "none";

        const message = `${sender}ÈÄÅÂá∫‰∫Ü‰∏ÄÂÄã ${giftEmoji} Á¶ÆÁâ©ÔºÅ`;

        if (message && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'sendGift',
                roomId: roomId,
                sender: sender,
                gift: giftEmoji
            }));
        }
    }

    function showGiftAnimation(sender, giftEmoji) {
        const videoPlaceholder = document.querySelector('.video-container');
        const gift = document.createElement('div');
        gift.className = 'gift';
        gift.textContent = giftEmoji;
        gift.style.left = `${Math.random() * 80 + 10}%`;
        videoPlaceholder.appendChild(gift);

        setTimeout(() => {
            gift.remove();
        }, 5000);
    }

    function displayChatMessage(message, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = document.createElement('div');
        if (sender === 'Á≥ªÁµ±') {
            messageElement.textContent = message;
        } else {
            messageElement.textContent = `${sender}: ${message}`;
        }
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function enableChat() {
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendMessage').disabled = false;
    }

    function disableChat() {
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendMessage').disabled = true;
    }

    function sendSignalingMessage(message) {
        const userId = localStorage.getItem("userId");
        const completeMessage = {
            ...message,
            userId: userId,
            roomId: roomId
        };
        console.log('ÁôºÈÄÅ Signaling Ê∂àÊÅØ:', completeMessage);
        signalingWs.send(JSON.stringify(completeMessage));
    }

    function setupMediaStream() {
        console.log('Ê≠£Âú®Áç≤ÂèñÁî®Êà∂Â™íÈ´îË®≠ÂÇô...');
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(stream => {
                console.log('ÊàêÂäüÁç≤ÂèñÂ™íÈ´îÊµÅ');
                videoStream.srcObject = stream;
                videoStream.muted = true;
                localStream = stream;
                videoLabel.textContent = 'Áõ¥Êí≠Áï´Èù¢';

                const urlParams2 = new URLSearchParams(window.location.search);
                const title = urlParams2.get('title');
                const description = urlParams2.get('description');
                const products = urlParams2.get('products');
                const productArray = products ? products.split(',') : [];

                console.log('ÁôºÈÄÅÂâµÂª∫ÊàøÈñìË´ãÊ±ÇÔºå‰∏¶ÈôÑÂä†Áî¢ÂìÅÈô£Âàó:', productArray);

                ws.send(JSON.stringify({
                    type: 'create',
                    roomId: roomId,
                    userId: localStorage.getItem("userId"),
                    title: title,
                    description: description,
                    products: productArray
                }));
                hangupButton.disabled = false;
                enableChat();
            })
            .catch(e => {
                updateStatus('Áç≤ÂèñÂ™íÈ´îË®≠ÂÇôÂ§±Êïó: ' + e.message);
                console.error('Áç≤ÂèñÂ™íÈ´îË®≠ÂÇôÂ§±Êïó:', e);
            });
    }



</script>
</body>
</html>
