<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一對一視訊通話</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
        }

        .video-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        video {
            width: 300px;
            height: 225px;
            background-color: black;
        }

        #roomInput, #joinButton {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
        }

        #debugInfo {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            width: 500px;
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<h1>一對一視訊通話</h1>
<input id="roomInput" type="text" placeholder="輸入房間名稱">
<button id="joinButton">加入房間</button>

<div class="video-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
</div>

<div id="debugInfo"></div>

<script>
    const signalingServerUrl = 'ws://localhost:8080/socket';
    let peerConnection;
    let localStream;
    let remoteStream;
    let ws;
    let roomName;

    const joinButton = document.getElementById('joinButton');
    const roomInput = document.getElementById('roomInput');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const debugInfo = document.getElementById('debugInfo');

    joinButton.onclick = joinRoom;

    function log(message) {
        console.log(message);
        debugInfo.textContent += message + '\n';
    }

    function joinRoom() {
        roomName = roomInput.value;
        if (!roomName) {
            alert('請輸入房間名稱');
            return;
        }

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localVideo.srcObject = stream;
                localStream = stream;
                connectSignalingServer();
                log('成功獲取本地媒體流');
            })
            .catch(e => {
                console.error(e);
                log('獲取本地媒體流失敗: ' + e.message);
            });
    }

    function connectSignalingServer() {
        ws = new WebSocket(signalingServerUrl);

        ws.onopen = () => {
            log('已連接到信令伺服器');
            ws.send(JSON.stringify({ type: 'join', room: roomName }));
        };

        ws.onmessage = message => {
            log('收到訊息: ' + message.data);

            // 檢查是否為有效的 JSON 格式
            if (isValidJSON(message.data)) {
                const data = JSON.parse(message.data);
                log('解析成功: ' + data.type);

                switch (data.type) {
                    case 'offer':
                        handleOffer(data);
                        break;
                    case 'answer':
                        handleAnswer(data);
                        break;
                    case 'ice-candidate':
                        handleIceCandidate(data);
                        break;
                    case 'user-joined':
                        createOffer();
                        break;
                    default:
                        log('未知的訊息類型: ' + data.type);
                        break;
                }
            } else {
                log('接收到非 JSON 訊息: ' + message.data);
            }
        };

        ws.onerror = (error) => log('WebSocket 錯誤: ' + error.message);
        ws.onclose = () => log('WebSocket 連接關閉');
    }

    function isValidJSON(data) {
        try {
            JSON.parse(data);
            return true;
        } catch (e) {
            return false;
        }
    }

    function createOffer() {
        peerConnection = createPeerConnection();
        peerConnection.createOffer()
            .then(offer => peerConnection.setLocalDescription(offer))
            .then(() => {
                ws.send(JSON.stringify({ type: 'offer', sdp: peerConnection.localDescription }));
            });
    }

    function handleOffer(data) {
        peerConnection = createPeerConnection();
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
            .then(() => peerConnection.createAnswer())
            .then(answer => peerConnection.setLocalDescription(answer))
            .then(() => {
                ws.send(JSON.stringify({ type: 'answer', sdp: peerConnection.localDescription }));
            });
    }

    function handleAnswer(data) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
    }

    function handleIceCandidate(data) {
        peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    }

    function createPeerConnection() {
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: 'turn:35.77.172.232:3478',      // 將此處替換為你的 TURN 伺服器的域名或 IP
                    username: 'sean',                    // 替換為你的 TURN 伺服器用戶名
                    credential: 'sean71507'              // 替換為你的 TURN 伺服器密碼
                }
            ]
        });

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = event => {
            if (event.candidate) {
                ws.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate }));
            }
        };

        pc.ontrack = event => {
            if (!remoteStream) {
                remoteStream = new MediaStream();
                remoteVideo.srcObject = remoteStream;
            }
            remoteStream.addTrack(event.track);
        };

        return pc;
    }
</script>

</body>
</html>

